<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
	"http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap>

<resultMap id="Users" class="cn.ibm.com.entity.Users">
	 <!-- <result property="id" column="ID"/> -->
	 <result property="user_id" column="USER_ID"/>
	 <result property="loginname" column="LOGINNAME"/>
	 <result property="password" column="PASSWORD"/>
	 <result property="create_time" column="CREATE_TIME"  />
	 <result property="login_time" column="LOGIN_TIME"  />
	 <result property="last_login_time" column="LAST_LOGIN_TIME"/>
	 <result property="login_count" column="LOGIN_COUNT"  />
 </resultMap>
   <insert id="insertUsers" parameterClass="cn.ibm.com.entity.Users">
        INSERT INTO USERS ( 
         <dynamic prepend="">
            <!-- <isNotEmpty prepend="" property="id">  ID  </isNotEmpty> -->
            <isNotEmpty prepend="" property="user_id">  USER_ID  </isNotEmpty>
            <isNotEmpty prepend="," property="loginname">  LOGINNAME  </isNotEmpty>
            <isNotEmpty prepend="," property="password">  PASSWORD  </isNotEmpty>
            <isNotEmpty prepend="," property="create_time">  CREATE_TIME  </isNotEmpty>
            <isNotEmpty prepend="," property="login_time">  LOGIN_TIME  </isNotEmpty>
            <isNotEmpty prepend="," property="last_login_time">  LAST_LOGIN_TIME  </isNotEmpty>
            <isNotEmpty prepend="," property="login_count">  LOGIN_COUNT  </isNotEmpty>
          </dynamic>         
         ) VALUES (
          <dynamic prepend="">
		    <!-- <isNotEmpty prepend="" property="id">  #id#  </isNotEmpty> -->
            <isNotEmpty prepend="" property="user_id">  #user_id#  </isNotEmpty>
            <isNotEmpty prepend="," property="loginname">  #loginname#  </isNotEmpty>
            <isNotEmpty prepend="," property="password">  #password#  </isNotEmpty>
            <isNotEmpty prepend="," property="create_time">  #create_time#  </isNotEmpty>
            <isNotEmpty prepend="," property="login_time">  #login_time#  </isNotEmpty>
            <isNotEmpty prepend="," property="last_login_time">  #last_login_time#  </isNotEmpty>
            <isNotEmpty prepend="," property="login_count">  #login_count#  </isNotEmpty>
           </dynamic>
         )
    </insert>



  <resultMap id="addUserMap" class="cn.ibm.com.entity.Users">
	 <result property="id" column="ID" nullValue=""/>
	 <result property="user_id" column="USER_ID" nullValue=""/>
	 <result property="loginname" column="LOGINNAME" nullValue=""/>
	 <result property="password" column="PASSWORD" nullValue=""/>
	 <result property="create_time" column="CREATE_TIME" nullValue=""/>
	 <result property="login_time" column="LOGIN_TIME" nullValue=""/>
	 <result property="last_login_time" column="LAST_LOGIN_TIME" nullValue=""/>
	 <result property="login_count" column="LOGIN_COUNT" nullValue=""/>
 </resultMap>
   <insert id="addUser" parameterClass="cn.ibm.com.entity.Users">
        INSERT INTO Users ( 
         <dynamic prepend="">
            <!-- <isNotEmpty prepend="" property="id">  ID  </isNotEmpty> -->
            <isNotEmpty prepend="" property="user_id">  USER_ID  </isNotEmpty>
            <isNotEmpty prepend="," property="loginname">  LOGINNAME  </isNotEmpty>
            <isNotEmpty prepend="," property="password">  PASSWORD  </isNotEmpty>
            <isNotEmpty prepend="," property="create_time">  CREATE_TIME  </isNotEmpty>
            <isNotEmpty prepend="," property="login_time">  LOGIN_TIME  </isNotEmpty>
            <isNotEmpty prepend="," property="last_login_time">  LAST_LOGIN_TIME  </isNotEmpty>
            <!-- <isNotEmpty prepend="," property="login_count">  LOGIN_COUNT  </isNotEmpty> -->
          </dynamic>         
         ) VALUES (
          <dynamic prepend="">
		    <!-- <isNotEmpty prepend="" property="id">  #id#  </isNotEmpty>	 -->       
		    <isNotEmpty prepend="" property="user_id">  #user_id#  </isNotEmpty>	       
		    <isNotEmpty prepend="," property="loginname">  #loginname#  </isNotEmpty>	       
		    <isNotEmpty prepend="," property="password">  #password#  </isNotEmpty>	       
		    <isNotEmpty prepend="," property="create_time">  #create_time#  </isNotEmpty>	       
		    <isNotEmpty prepend="," property="login_time">  #login_time#  </isNotEmpty>	       
		    <isNotEmpty prepend="," property="last_login_time">  #last_login_time#  </isNotEmpty>
		    <!-- <isNotEmpty prepend="," property="login_count">  #login_count#  </isNotEmpty> -->
           </dynamic>
         )
    </insert>


   <select id="getUsers" resultMap="Users">  
        SELECT 
	           
			    USER_ID,
			    LOGINNAME,
			    PASSWORD,
			    CREATE_TIME,
			    LOGIN_TIME,
			    LAST_LOGIN_TIME,
			    LOGIN_COUNT
         FROM USERS
      <dynamic prepend="WHERE">
         <isNotEmpty prepend="AND" property="loginname"> LOGINNAME = #loginname# </isNotEmpty>         
      </dynamic>
  </select>
  
  <update id="updateUsers" parameterClass="cn.ibm.com.entity.Users">  
      UPDATE USERS       
        <dynamic prepend="SET">
            <!-- <isNotEmpty prepend="," property="id">  ID = #id#  </isNotEmpty> -->
            <!-- <isNotEmpty prepend="" property="user_id">  USER_ID = #user_id#  </isNotEmpty> -->
            <isNotEmpty prepend="," property="loginname">  LOGINNAME = #loginname#  </isNotEmpty>
            <isNotEmpty prepend="," property="password">  PASSWORD = #password#  </isNotEmpty>
            <isNotEmpty prepend="," property="create_time">  CREATE_TIME = #create_time#  </isNotEmpty>
            <isNotEmpty prepend="," property="login_time">  LOGIN_TIME = #login_time#  </isNotEmpty>
            <isNotEmpty prepend="," property="last_login_time">  LAST_LOGIN_TIME = #last_login_time#  </isNotEmpty>
            <isNotEmpty prepend="," property="login_count">  LOGIN_COUNT = #login_count#  </isNotEmpty>
           
        </dynamic>
       WHERE USER_ID = #user_id#
  </update>

<!-- 
<select id="listAmAccountDiagnosisStrategy" parameterClass="java.util.Map" resultMap="AmAccountDiagnosisStrategy">  
      SELECT 
	       ID,
	       ACCOUNTNO,
	       STRATEGYTYPE,
	       STRATEGYCONTENT,
	       CREATEDATE,
	       KEY_ACCOUNT_DATE,
	       ORDERID,
	        ENTRYTIME,
	       CUSTOMERCODE 
	  FROM AM_ACCOUNT_DIAGNOSIS_STRATEGY
        <dynamic prepend="WHERE">
          <isNotEmpty prepend="AND" property="id"> ID = #id# </isNotEmpty> 
          <isNotEmpty prepend="AND" property="accountdate"> KEY_ACCOUNT_DATE = #accountdate# </isNotEmpty>                 
        </dynamic>
		  <isEmpty prepend="ORDER BY" property="orderByFlag"> CREATEDATE DESC </isEmpty>
          <isEqual prepend="ORDER BY" property="orderByFlag" compareValue="0"> CREATEDATE DESC </isEqual>
          <isEqual prepend="ORDER BY" property="orderByFlag" compareValue="1"> CREATEDATE ASC </isEqual>
  </select>
 -->
<!-- new user for operator by default -->
  <insert id="insertNewUserRoleByDefault" parameterClass="java.util.HashMap">
        INSERT INTO USER_ROLES_RELATION ( 
         <dynamic prepend="">
            <!-- <isNotEmpty prepend="" property="id">  ID  </isNotEmpty> -->
            <isNotEmpty prepend="" property="user_id">  USER_ID  </isNotEmpty>
            <isNotEmpty prepend="," property="role_id">  ROLE_ID  </isNotEmpty>
            <isNotEmpty prepend="," property="type">  TYPE  </isNotEmpty>
          </dynamic>         
         ) VALUES (
          <dynamic prepend="">
		    <!-- <isNotEmpty prepend="" property="id">  #id#  </isNotEmpty>	 -->       
		    <isNotEmpty prepend="" property="user_id">  #user_id#  </isNotEmpty>	       
		    <isNotEmpty prepend="," property="role_id">  #role_id#  </isNotEmpty>	       
		    <isNotEmpty prepend="," property="type">  #type#  </isNotEmpty>	       
           </dynamic>
         )
    </insert>

<!-- get the use role by loginname -->
  <resultMap id="getUserRoleByLoginnameResult" class="java.util.HashMap">
  <!-- 
  	 <result property="loginname" column="LOGINNAME" nullValue=""/>
	 <result property="user_id" column="USER_ID" nullValue=""/>
	 <result property="role_id" column="ROLE_ID" nullValue=""/>
	 <result property="role_name" column="ROLE_NAME" nullValue=""/>
   -->
	 <result property="loginname" column="LOGINNAME"/>
	 <result property="user_id" column="USER_ID"/>
	 <result property="role_id" column="ROLE_ID"/>
	 <result property="role_name" column="ROLE_NAME"/>
 </resultMap>
 
 <select id="getUserRoleByLoginname" parameterClass="java.util.Map" resultMap="getUserRoleByLoginnameResult">  
SELECT
    p.loginname,
    p.user_id,
    r.role_id,
    r.role_name
FROM
    ROLES r
LEFT JOIN
    User_roles_relation o
ON
    o.role_id = r.role_id
LEFT JOIN
    users p
ON
    p.user_id = o.user_id
<dynamic prepend="WHERE">
          <isNotEmpty prepend="AND" property="loginname"> p.loginname = #loginname# </isNotEmpty> 
</dynamic>
        
        <!--  
		  <isEmpty prepend="ORDER BY" property="orderByFlag"> CREATEDATE DESC </isEmpty>
          <isEqual prepend="ORDER BY" property="orderByFlag" compareValue="0"> CREATEDATE DESC </isEqual>
          <isEqual prepend="ORDER BY" property="orderByFlag" compareValue="1"> CREATEDATE ASC </isEqual>
          -->
  </select>
  
  
  <!-- get the use permission url by loginname -->
  <resultMap id="getUserPrivilegeUrlByLoginnameResult" class="java.util.HashMap">
  <!-- 
  	 <result property="loginname" column="LOGINNAME" nullValue=""/>
	 <result property="user_id" column="USER_ID" nullValue=""/>
	 <result property="role_id" column="ROLE_ID" nullValue=""/>
	 <result property="role_name" column="ROLE_NAME" nullValue=""/>
   -->
	 <result property="privilege_id" column="PRIVILEGE_ID"/>
	 <result property="privilege_name" column="PRIVILEGE_NAME"/>
	 <result property="privilege_url" column="PRIVILEGE_URL"/>
 </resultMap>
 
 <select id="getUserPrivilegeUrlByLoginname" parameterClass="java.util.Map" resultMap="getUserPrivilegeUrlByLoginnameResult">  
SELECT
    t.privilege_id,
    t.privilege_name,
    t.privilege_url
FROM
    privilege t
LEFT JOIN
    role_privilege_relation r
ON
    r.privilege_id = t.privilege_id
LEFT JOIN
    roles s
ON
    r.role_id = s.role_id
LEFT JOIN
    user_roles_relation p
ON
    p.role_id = s.role_id
LEFT JOIN
    users o
ON
    o.user_id = p.user_id

<dynamic prepend="WHERE">
          <isNotEmpty prepend="AND" property="loginname"> o.loginname = #loginname# </isNotEmpty> 
</dynamic>

  </select>
  
  
  
  <!-- get the use role List -->
  <resultMap id="getListOfUserRoleResult" class="java.util.HashMap">
  <!-- 
  	 <result property="loginname" column="LOGINNAME" nullValue=""/>
	 <result property="user_id" column="USER_ID" nullValue=""/>
	 <result property="role_id" column="ROLE_ID" nullValue=""/>
	 <result property="role_name" column="ROLE_NAME" nullValue=""/>
   -->
	 <result property="loginname" column="LOGINNAME"/>
	 <result property="user_id" column="USER_ID"/>
	 <result property="role_id" column="ROLE_ID"/>
	 <result property="role_name" column="ROLE_NAME"/>
 </resultMap>
 
 <select id="getListOfUserRole" parameterClass="java.util.Map" resultMap="getListOfUserRoleResult">  
SELECT
    p.loginname,
    p.user_id,
    r.role_id,
    r.role_name
FROM
    ROLES r
LEFT JOIN
    User_roles_relation o
ON
    o.role_id = r.role_id
LEFT JOIN
    users p
ON
    p.user_id = o.user_id
WHERE LOGINNAME IS NOT NULL
        <!--  
		  <isEmpty prepend="ORDER BY" property="orderByFlag"> CREATEDATE DESC </isEmpty>
          <isEqual prepend="ORDER BY" property="orderByFlag" compareValue="0"> CREATEDATE DESC </isEqual>
          <isEqual prepend="ORDER BY" property="orderByFlag" compareValue="1"> CREATEDATE ASC </isEqual>
          -->
  </select>

<!-- 获得User表中 是否存在该User -->
	<select id="getCountOfUser" parameterClass="java.util.HashMap" resultClass="int">
SELECT
    COUNT(1)
FROM
    USERS t
     <dynamic prepend="WHERE">
  		<isNotEmpty prepend="AND" property="loginname"> t.loginname <![CDATA[ = ]]> #loginname# </isNotEmpty>
  	</dynamic>

	</select>
	
	
	<update id="updateUserRoleRelation" parameterClass="java.util.HashMap">  
      UPDATE USER_ROLES_RELATION       
        <dynamic prepend="SET">
            <isNotEmpty prepend="," property="loginname">  USER_ID = (select user_id from Users where loginname  = #loginname#)  </isNotEmpty>
            <isNotEmpty prepend="," property="role_name">  ROLE_ID = (select role_id from roles where role_name = #role_name#) </isNotEmpty>
            <isNotEmpty prepend="," property="type">  TYPE = #type# </isNotEmpty>
        </dynamic>
       WHERE USER_ID = (select user_id from Users where loginname = #loginname#)
  </update>

</sqlMap>
